(function(b,m,e){function f(a,c){this.element=b(a);this.options=b.extend({},l,c);this.defaults=l;this.initialise()}var l={};f.prototype.initialise=function(){var a=this;this.body=b(this.element).children("tbody").first();this.newRow=b(this.element).children("tbody").last().children("tr");this.footer=b(this.element).children("tfoot").children("tr");this.addButton=this.footer.find(".add-button");this.fieldName=b(this.element).attr("id");var c=b(this.element).data();this.isDirtyProperty=c.isdirtyproperty;
this.isActiveProperty=c.isactiveproperty;this.newRowIndex=this.body.children("tr").length;if(0<this.newRow.find(".numeric-input").length&&!b.fn.numeric)console.error("The sandtrap-numeric plugin not loaded");else if(0<this.newRow.find(".select-input").length&&!b.fn.select)console.error("The sandtrap-select plugin not loaded");else{this.body.find(".numeric-input").numeric();this.body.find(".select-input").children('input[type="text"]').select();c=this.newRow.find("input");if(this.isActiveProperty!==
e){var d='[name="'+this.fieldName+"[#]."+this.isActiveProperty+'"]';1!==c.filter(d).length&&(this.isActiveProperty=e)}this.isDirtyProperty!==e&&(d='[name="'+this.fieldName+"[#]."+this.isDirtyProperty+'"]',1!==c.filter(d).length&&(this.isDirtyProperty=e));this.addButton.click(function(b){a.addRow()});this.body.on("click",".table-button",function(){var c=b(this).closest("tr");a.deleteRow(c)});this.body.on("change itemSelected.select","input",function(){if(a.isDirtyProperty===e)a.body.off("change itemSelected.select");
else{var c=b(this).closest("tr"),d=c.find("input"),f='[name="'+a.fieldName+"["+c.index()+"]."+a.isDirtyProperty+'"]',d=d.filter(f);b(this).parent().is(".select-input")?d.val("True"):d.val(a.isDirty(c)?"True":"False")}});this.element.on("keydown","input",function(a){})}};f.prototype.updateTotals=function(a){var c=0,d=b(a).closest("td").index();b.each(this.body.children("tr"),function(a,e){b(e).hasClass("archived")||(c+=new Number(b(e).children("td").eq(d).find(".numeric-input").val()))});b(a).prev("").hasClass("currency")?
this.footer.children("td").eq(d).text(c.toCurrency()):this.footer.children("td").eq(d).text(c.toFixed(2))};f.prototype.addRow=function(){var a=this.newRow.clone();a.html(b(a).html().replace(/\[#\]/g,"["+this.newRowIndex+"]"));a.html(b(a).html().replace(/"%"/g,'"'+this.newRowIndex+'"'));this.newRowIndex++;a.data("isnew",!0);this.body.append(a);a.find(".select-input").children('input[type="text"]').select();a.find(".numeric-input").numeric();b.validator&&(this.element.closest("form").removeData("validator").removeData("unobtrusiveValidation"),
b.validator.unobtrusive.parse("form"));a.find("input:not([type=hidden])").first().focus()};f.prototype.deleteRow=function(a){var c=this;a=b(a);if(a.data("isnew"))a.remove();else{var d=a.find("input"),f=a.find('input[type="checkbox"]'),g=e,h=e;if(this.isActiveProperty!==e)var k='[name="'+this.fieldName+"["+a.index()+"]."+this.isActiveProperty+'"]',g=d.filter(k);this.isDirtyProperty!==e&&(k='[name="'+this.fieldName+"["+a.index()+"]."+this.isDirtyProperty+'"]',h=d.filter(k));a.hasClass("archived")?(a.removeClass("archived"),
d.prop("readonly",!1),f.off(),g.val("True"),h.val(this.isDirty(a)?"True":"False"),b(this.element).trigger({type:"rowActivated.table",index:a.index()})):(a.addClass("archived"),d.prop("readonly",!0),f.on("click",function(){return!1}),g.val("False"),h.val("True"),b(this.element).trigger({type:"rowDeleted.table",index:a.index()}))}a.find(".numeric-input").each(function(){c.updateTotals(b(this))})};f.prototype.isDirty=function(a){var c=!1;a=b(a).find("input");b.each(a,function(){var a=b(this);if(a.is(":checkbox")&&
a.prop("checked")!==a.prop("defaultChecked")||a.val()!==a.prop("defaultValue"))return c=!0,!1});return c};b.fn.table=function(a){return this.each(function(){b.data(this,"table")||b.data(this,"table",new f(this,a))})}})(jQuery,window);